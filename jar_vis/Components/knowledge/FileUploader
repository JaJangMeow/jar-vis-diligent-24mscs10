
import React, { useState } from "react";
import { Button } from "@/components/ui/button";
import { Progress } from "@/components/ui/progress";
import { Upload, FileText, Loader2, CheckCircle } from "lucide-react";
import { base44 } from "@/api/base44Client";
import { Card, CardContent } from "@/components/ui/card";

export default function FileUploader({ onSuccess }) {
  const [uploading, setUploading] = useState(false);
  const [progress, setProgress] = useState(0);
  const [fileName, setFileName] = useState("");

  const handleFileUpload = async (event) => {
    const file = event.target.files?.[0];
    if (!file) return;

    setUploading(true);
    setFileName(file.name);
    setProgress(10);

    try {
      // Upload file
      const { file_url } = await base44.integrations.Core.UploadFile({ file });
      setProgress(40);

      // Extract content from file
      const result = await base44.integrations.Core.InvokeLLM({
        prompt: `Extract all the important information, knowledge, and content from this file. 
Summarize key points, concepts, and any relevant data. 
Structure the output as clear, organized knowledge that can be stored and referenced later.`,
        file_urls: [file_url],
      });
      setProgress(80);

      // Create knowledge base entry
      await base44.entities.KnowledgeBase.create({
        title: `Extracted from: ${file.name}`,
        content: result,
        category: "documents",
        tags: ["uploaded", "file"],
      });

      setProgress(100);
      
      setTimeout(() => {
        onSuccess?.();
        setUploading(false);
        setProgress(0);
        setFileName("");
      }, 1000);
    } catch (error) {
      console.error("Error processing file:", error);
      alert("Failed to process file. Please try again.");
      setUploading(false);
      setProgress(0);
    }
  };

  return (
    <div className="space-y-4">
      <input
        type="file"
        id="file-upload"
        className="hidden"
        onChange={handleFileUpload}
        disabled={uploading}
        accept=".pdf,.doc,.docx,.txt,.md,.csv,.json"
      />
      
      {!uploading ? (
        <label htmlFor="file-upload">
          <Button
            type="button"
            variant="outline"
            className="w-full cursor-pointer border-gray-700 bg-gray-800 hover:bg-gray-700 text-gray-300"
            asChild
          >
            <span>
              <Upload className="w-4 h-4 mr-2" />
              Upload File to Extract Knowledge
            </span>
          </Button>
        </label>
      ) : (
        <Card className="bg-gray-800 border-gray-700">
          <CardContent className="pt-6">
            <div className="space-y-3">
              <div className="flex items-center gap-3">
                {progress === 100 ? (
                  <CheckCircle className="w-5 h-5 text-green-400" />
                ) : (
                  <Loader2 className="w-5 h-5 animate-spin text-cyan-400" />
                )}
                <div className="flex-1 min-w-0">
                  <p className="text-sm font-medium truncate text-white">{fileName}</p>
                  <p className="text-xs text-gray-400">
                    {progress < 40 && "Uploading file..."}
                    {progress >= 40 && progress < 80 && "Extracting knowledge..."}
                    {progress >= 80 && progress < 100 && "Saving to knowledge base..."}
                    {progress === 100 && "Complete!"}
                  </p>
                </div>
              </div>
              <Progress value={progress} className="h-2" />
            </div>
          </CardContent>
        </Card>
      )}

      <p className="text-xs text-gray-500 text-center">
        Supported: PDF, DOC, DOCX, TXT, MD, CSV, JSON
      </p>
    </div>
  );
}
